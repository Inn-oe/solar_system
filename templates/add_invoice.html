{% extends 'base.html' %}

{% block title %}Create Invoice - Giebee Engineering{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Create New Invoice</h2>
    <a href="{{ url_for('invoices') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Invoices
    </a>
</div>

<div class="card bg-transparent border-0">
    <div class="card-body p-0">
        <form method="POST" action="{{ url_for('add_invoice') }}">
            <!-- Customer Section -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent border-bottom-0 pt-4 px-4 pb-0">
                    <h5 class="mb-0 fw-bold text-primary"><i class="fas fa-user-circle me-2"></i>Customer Details</h5>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="activity_type_id" class="form-label fw-medium">Activity Type</label>
                            <select class="form-select" id="activity_type_id" name="activity_type_id">
                                <option value="">-- Select Activity Type --</option>
                                {% for at in activity_types %}
                                <option value="{{ at.id }}">{{ at.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="customer_identification" class="form-label fw-medium">Identification Number
                                <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="customer_identification"
                                name="customer_identification" required list="customer-list-quotes"
                                placeholder="Start typing ID number...">
                            <datalist id="customer-list-quotes">
                                {% for quote in quotations %}
                                <option value="{{ quote.customer_id }}">{{ quote.number }} (Customer ID: {{
                                    quote.customer_id }})</option>
                                {% endfor %}
                            </datalist>
                        </div>
                        <div class="col-md-4">
                            <label for="customer_name_display" class="form-label fw-medium">Customer Name</label>
                            <input type="text" class="form-control" id="customer_name_display"
                                list="customer-name-list-quotes" placeholder="Start typing Name...">
                            <datalist id="customer-name-list-quotes">
                                {% for quote in quotations %}
                                <option value="{{ quote.number }}">ID: {{ quote.customer_id }}</option>
                                {% endfor %}
                            </datalist>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <label for="quotation_id" class="form-label fw-medium">Link Quotation (Optional)</label>
                            <select class="form-select border-primary" id="quotation_id" name="quotation_id">
                                <option value="">-- No Quotation Linked --</option>
                                <!-- Population handled by JS -->
                            </select>
                            <div class="form-text text-muted small">Select a customer first to see their quotations.
                                Linking a quotation will auto-populate items.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Items Section -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent border-bottom-0 pt-4 px-4 pb-0">
                    <h5 class="mb-0 fw-bold text-primary"><i class="fas fa-box-open me-2"></i>Invoice Items</h5>
                </div>
                <div class="card-body p-4">
                    <!-- Item Datalist -->
                    <datalist id="invoice-inventory-list">
                        {% for item in inventory_items %}
                        <option value="{{ item.name }}" data-id="{{ item.id }}" data-price="{{ item.unit_price }}">
                            Stock: {{ item.quantity }}</option>
                        {% endfor %}
                        <option value="Create Custom Item"></option>
                    </datalist>

                    <div class="table-responsive mb-3">
                        <table class="table table-bordered" id="itemsTable">
                            <thead>
                                <tr>
                                    <th style="width: 40%;">Item</th>
                                    <th style="width: 15%;">Quantity</th>
                                    <th style="width: 20%;">Unit Price</th>
                                    <th style="width: 20%;">Total</th>
                                    <th style="width: 5%;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="itemsBody">
                                <tr>
                                    <td>
                                        <input type="hidden" name="item_id[]" class="item-id">
                                        <input type="text" class="form-control item-search" name="item_search[]"
                                            list="invoice-inventory-list"
                                            placeholder="Search item or type new item name..." required
                                            onchange="updateItemFromSearch(this)">

                                        <input type="text" class="form-control mt-2 custom-item-name"
                                            name="custom_item_name[]" placeholder="Enter Item Name"
                                            style="display: none;">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control quantity-input" name="quantity[]"
                                            value="1" min="1" required oninput="calculateRowTotal(this)">
                                    </td>
                                    <td>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control price-input" name="unit_price[]"
                                                step="0.01" required oninput="calculateRowTotal(this)">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="text" class="form-control total-input" readonly value="0.00">
                                        </div>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-secondary" onclick="addRow()">
                                <i class="fas fa-plus me-2"></i>Add Item
                            </button>
                        </div>
                        <div class="col-md-6 text-end">
                            <h4>Total Amount: $<span id="grandTotal">0.00</span></h4>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg">Create Invoice</button>
            </div>
        </form>
    </div>
</div>

<script>
    const allQuotations = {{ quotations| tojson }};

    document.addEventListener('DOMContentLoaded', function () {
        const customerIdInput = document.getElementById('customer_identification');
        const customerNameInput = document.getElementById('customer_name_display');
        const quotationSelect = document.getElementById('quotation_id');

        // Function to filter quotations dropdown
        function updateQuotationDropdown(cid) {
            quotationSelect.innerHTML = '<option value="">-- No Quotation Linked --</option>';
            const filtered = allQuotations.filter(q => q.customer_id === cid);
            filtered.forEach(q => {
                const opt = document.createElement('option');
                opt.value = q.id;
                opt.textContent = q.number;
                quotationSelect.appendChild(opt);
            });
        }

        if (customerIdInput) {
            customerIdInput.addEventListener('change', function () {
                updateQuotationDropdown(this.value);
            });
            // Also trigger on input in case they select from datalist
            customerIdInput.addEventListener('input', function () {
                updateQuotationDropdown(this.value);
            });
        }

        // Handle Quotation Selection
        quotationSelect.addEventListener('change', function () {
            const qId = parseInt(this.value);
            if (!qId) return;

            const q = allQuotations.find(quote => quote.id === qId);
            if (q && q.items && q.items.length > 0) {
                if (confirm(`Populate invoice items from Quotation ${q.number}? This will replace current items.`)) {
                    // Clear existing items
                    const itemsBody = document.getElementById('itemsBody');
                    itemsBody.innerHTML = '';

                    // Add items from quotation
                    q.items.forEach(item => {
                        const newRow = addRow();

                        // Set Hidden ID
                        newRow.querySelector('.item-id').value = item.inventory_id;

                        // Set Search Input (Visible Name)
                        const searchInput = newRow.querySelector('.item-search');
                        searchInput.value = item.name;

                        // Set Quantity
                        newRow.querySelector('.quantity-input').value = item.quantity;

                        // Set Unit Price
                        newRow.querySelector('.price-input').value = item.unit_price;

                        // If custom item, handle display
                        if (item.inventory_id === 'custom') {
                            const customInput = newRow.querySelector('.custom-item-name');
                            customInput.value = item.name;
                            customInput.style.display = 'block';
                        }

                        // Calculate totals for the row
                        calculateRowTotal(searchInput);
                    });
                }
            } else if (q) {
                alert("This quotation has no items.");
            }
        });
    });

    function updateItemFromSearch(input) {
        const val = input.value;
        const row = input.closest('tr');
        const hiddenIdInput = row.querySelector('.item-id');
        const priceInput = row.querySelector('.price-input');
        const customInput = row.querySelector('.custom-item-name');

        const datalist = document.getElementById('invoice-inventory-list');
        let selectedOption = null;
        for (let option of datalist.options) {
            if (option.value === val) {
                selectedOption = option;
                break;
            }
        }

        if (selectedOption && val !== 'Create Custom Item') {
            hiddenIdInput.value = selectedOption.dataset.id;
            priceInput.value = selectedOption.dataset.price;
            customInput.style.display = 'none';
            customInput.required = false;
            customInput.value = '';
            input.setCustomValidity("");
        } else if (val) {
            hiddenIdInput.value = 'custom';
            if (val === 'Create Custom Item') {
                customInput.value = '';
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.value = val;
                customInput.style.display = 'none';
                customInput.required = false;
            }
            input.setCustomValidity("");
        } else {
            hiddenIdInput.value = '';
            priceInput.value = '';
            input.setCustomValidity("Please select a valid item or type new item name");
        }
        calculateRowTotal(input);
    }

    function calculateRowTotal(element) {
        const row = element.closest('tr');
        const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
        const price = parseFloat(row.querySelector('.price-input').value) || 0;
        const total = quantity * price;
        row.querySelector('.total-input').value = total.toFixed(2);
        calculateGrandTotal();
    }

    function calculateGrandTotal() {
        let total = 0;
        document.querySelectorAll('.total-input').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        document.getElementById('grandTotal').innerText = total.toFixed(2);
    }

    function addRow() {
        const tbody = document.getElementById('itemsBody');
        const newRow = document.createElement('tr');

        newRow.innerHTML = `
            <td>
                <input type="hidden" name="item_id[]" class="item-id">
                <input type="text" class="form-control item-search" name="item_search[]" list="invoice-inventory-list"
                    placeholder="Search item or type new item name..." required onchange="updateItemFromSearch(this)">
                <input type="text" class="form-control mt-2 custom-item-name"
                    name="custom_item_name[]" placeholder="Enter Item Name"
                    style="display: none;">
            </td>
            <td>
                <input type="number" class="form-control quantity-input" name="quantity[]"
                    value="1" min="1" required oninput="calculateRowTotal(this)">
            </td>
            <td>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" class="form-control price-input" name="unit_price[]"
                        step="0.01" required oninput="calculateRowTotal(this)">
                </div>
            </td>
            <td>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="text" class="form-control total-input" readonly value="0.00">
                </div>
            </td>
            <td>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;

        tbody.appendChild(newRow);
        return newRow;
    }

    function removeRow(btn) {
        const tbody = document.getElementById('itemsBody');
        if (tbody.children.length > 1) {
            btn.closest('tr').remove();
            calculateGrandTotal();
        }
    }
</script>
{% endblock %}